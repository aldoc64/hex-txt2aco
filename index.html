<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HEX / TXT → ACO — Single-file converter</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:#f7fafc;color:#0f172a;margin:0;padding:20px}
    .wrap{max-width:900px;margin:0 auto;background:white;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(12,23,40,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    p.note{margin:6px 0 16px;color:#475569;font-size:13px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=file], textarea, input[type=text]{width:100%;padding:8px;border:1px solid #e6edf3;border-radius:6px}
    textarea{min-height:120px;font-family:monospace}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;background:#0ea5e9;color:white;cursor:pointer}
    .btn.ghost{background:white;border:1px solid #cbd5e1;color:#0f172a}
    .preview{display:grid;grid-template-columns:repeat(auto-fit,minmax(56px,1fr));gap:8px;margin-top:12px}
    .swatch{height:56px;border-radius:6px;border:1px solid #e6edf3;display:flex;align-items:center;justify-content:center;font-size:11px;color:rgba(0,0,0,0.6)}
    .footer{font-size:12px;color:#64748b;margin-top:40px;display: flex;justify-content: center}
    .message{margin-top:8px;color:#0f172a}
    .drop{border:2px dashed #e2e8f0;padding:12px;border-radius:8px;text-align:center;color:#64748b}
    a.link{color:#0ea5e9}
    .small{font-size:12px;color:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Convertitore .hex / .txt → .aco (single-file)</h1>
    <p class="note">Carica un semplice file di testo con codici <code>#RRGGBB</code>, oppure incolla la lista nella textarea. Scarica un <code>.aco</code> compatibile con Photoshop / Photopea.</p>
    <p class="note">Funziona anche offline nel browser</p>

    <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start">
      <div>
        <label>File (.hex, .txt)</label>
        <input id="file" type="file" accept=".hex,.txt,.pal" />

        <div style="height:10px"></div>

        <label>oppure incolla qui (es. <code>#ff0000</code> per riga)</label>
        <textarea id="paste" placeholder="#ff0000\n#00ff00 My green\n#0000ff"></textarea>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="importText" class="btn">Importa dal testo</button>
          <button id="clear" class="btn ghost">Pulisci</button>
        </div>

        <div style="height:10px"></div>

        <div id="drop" class="drop">Oppure trascina qui un file .hex / .txt</div>

        <div class="message" id="message"></div>
      </div>

      <div>
        <label>Anteprima</label>
        <div id="preview" class="preview"></div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="download" class="btn">Converti & Scarica .aco</button>
          <button id="downloadName" class="btn ghost">Imposta nome...</button>
        </div>

        <div style="margin-top:8px">
          <input id="filename" type="text" placeholder="palette.aco" value="palette.aco" />
        </div>

        <div class="footer">
          <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
          <script type='text/javascript'>kofiwidget2.init('Support me on Ko-fi', '#72a4f2', 'Z8Z4XHWCD');kofiwidget2.draw();</script> 
        </div>
      </div>
    </div>
  </div>

<script>
// ---------- Utility parsing functions ----------
function parseHEX(text) {
  const lines = text.split(/\r?\n/);
  const out = [];
  for (const raw of lines) {
    const line = raw.trim();
    if (!line) continue;

    const m = line.match(/^#?([0-9a-fA-F]{8}|[0-9a-fA-F]{6})\s*(.*)?$/); // CORREZIONE: Regex modificata
    if (m) {
      let hex = m[1];
      if (hex.length === 8) {
        hex = hex.substring(2);
      }
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      const name = (m[2] || '').trim();
      out.push({ r, g, b, name });
    }
  }
  // DEBUG: Stampa l'array di colori nella console prima di restituirlo
  console.log('Contenuto della variabile "out" dopo la conversione:', out);
  return out;
}

function detectAndParse(text) {
  let parsed = [];
  parsed = parseHEX(text);
  return parsed;
}

// ---------- ACO builder (big-endian byte array) ----------
function component8to16(v){ return Math.round(v * 257); }
function pushUint16(arr, v){ arr.push((v>>8)&0xFF); arr.push(v&0xFF); }
function pushUint32(arr, v){ arr.push((v>>24)&0xFF); arr.push((v>>16)&0xFF); arr.push((v>>8)&0xFF); arr.push(v&0xFF); }
function pushUTF16BE(arr, str){ for (let i=0;i<str.length;i++){ const code = str.charCodeAt(i); arr.push((code>>8)&0xFF); arr.push(code&0xFF); } }

function buildACO(colors){
  const bytes = [];
  const n = colors.length;
  // Version 1
  pushUint16(bytes,1);
  pushUint16(bytes,n);
  for (const c of colors){ pushUint16(bytes,0); pushUint16(bytes,component8to16(c.r)); pushUint16(bytes,component8to16(c.g)); pushUint16(bytes,component8to16(c.b)); pushUint16(bytes,0); }
  // Version 2
  pushUint16(bytes,2);
  pushUint16(bytes,n);
  for (const c of colors){ pushUint16(bytes,0); pushUint16(bytes,component8to16(c.r)); pushUint16(bytes,component8to16(c.g)); pushUint16(bytes,component8to16(c.b)); pushUint16(bytes,0);
    const name = c.name||''; const nameLen = name.length; pushUint32(bytes,nameLen);
    if (nameLen>0) pushUTF16BE(bytes,name);
  }
  return new Uint8Array(bytes);
}

// ---------- UI wiring ----------
const fileInput = document.getElementById('file');
const paste = document.getElementById('paste');
const importText = document.getElementById('importText');
const clearBtn = document.getElementById('clear');
const preview = document.getElementById('preview');
const message = document.getElementById('message');
const download = document.getElementById('download');
const filenameInput = document.getElementById('filename');
const drop = document.getElementById('drop');
let currentColors = [];

function showMessage(txt){ message.textContent = txt || ''; }
function renderPreview(colors){ preview.innerHTML=''; if(!colors||colors.length===0){ preview.innerHTML='<div class="small">Nessuna anteprima disponibile</div>'; return; } for (const c of colors){ const d = document.createElement('div'); d.className='swatch'; d.style.background = `rgb(${c.r},${c.g},${c.b})`; d.title = `${c.name||''} rgb(${c.r},${c.g},${c.b})`; d.textContent = ''; preview.appendChild(d); } }

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const parsed = detectAndParse(txt);
  if(parsed.length===0){
    showMessage('Nessun colore riconosciuto');
    return;
  }
  currentColors = parsed;
  renderPreview(currentColors);
  showMessage(`Importati ${parsed.length} colori`);
  const baseName = f.name.split('.').slice(0, -1).join('.');
  filenameInput.value = `${baseName}.aco`;
});

importText.addEventListener('click', ()=>{
  const txt = paste.value; if(!txt) return showMessage('Incolla prima qualcosa'); const parsed = detectAndParse(txt); if(parsed.length===0) return showMessage('Nessun colore riconosciuto nel testo'); currentColors = parsed; renderPreview(currentColors); showMessage(`Importati ${parsed.length} colori`);
});

clearBtn.addEventListener('click', ()=>{ paste.value=''; fileInput.value=''; currentColors=[]; renderPreview([]); showMessage('Pulito'); });

['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.style.borderColor='#94a3b8'; }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.style.borderColor='#e2e8f0'; }));
drop.addEventListener('drop', async (e)=>{
  const f = e.dataTransfer.files[0];
  if(!f) return;
  const txt = await f.text();
  const parsed = detectAndParse(txt);
  if(parsed.length===0){
    showMessage('Nessun colore riconosciuto');
    return;
  }
  currentColors = parsed;
  renderPreview(currentColors);
  showMessage(`Importati ${parsed.length} colori`);
  const baseName = f.name.split('.').slice(0, -1).join('.');
  filenameInput.value = `${baseName}.aco`;
});

download.addEventListener('click', ()=>{
  if(!currentColors || currentColors.length===0) return showMessage('Nessun colore da esportare');
  const data = buildACO(currentColors);
  const blob = new Blob([data],{type:'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = filenameInput.value || 'palette.aco'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showMessage('Scaricato ' + a.download);
});

renderPreview([]);
</script>
</body>
</html>
